# Firebase SQL éƒ¨ç½²æ‘˜è¦

## ğŸ“‹ ä»»å‹™å®Œæˆæƒ…æ³

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. è‡ªå‹•åŒ–éƒ¨ç½²è…³æœ¬

**åŠŸèƒ½**ï¼š
- âœ… è‡ªå‹•æª¢æŸ¥ç’°å¢ƒä¾è³´ï¼ˆpsql, Firebase CLIï¼‰
- âœ… æ¸¬è©¦è³‡æ–™åº«é€£ç·š
- âœ… ä¾åºåŸ·è¡Œæ‰€æœ‰ 6 å€‹ migration æª”æ¡ˆ
- âœ… å³æ™‚é¡¯ç¤ºåŸ·è¡Œé€²åº¦å’Œçµæœ
- âœ… è‡ªå‹•æ•æ‰ä¸¦é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
- âœ… åŸ·è¡Œéƒ¨ç½²é©—è­‰æ¸¬è©¦
- âœ… ç”Ÿæˆè©³ç´°çš„éƒ¨ç½²æ‘˜è¦

**ä½¿ç”¨æ–¹å¼**ï¼š
```bash
export DATABASE_URL='postgresql://postgres:YOUR_PASSWORD@db.zecsbstjqjqoytwgjyct.firebase.co:5432/postgres'
```

### 2. å®Œæ•´ä¸­æ–‡éƒ¨ç½²æŒ‡å—

å»ºç«‹äº† `firebase/éƒ¨ç½²æŒ‡å—.md` - è©³ç´°çš„éƒ¨ç½²æ–‡æª”

**å…§å®¹åŒ…å«**ï¼š
- ğŸ“– å››ç¨®éƒ¨ç½²æ–¹æ³•ï¼ˆè…³æœ¬ã€Dashboardã€CLIã€psqlï¼‰
- ğŸ” å®Œæ•´çš„é©—è­‰æ­¥é©Ÿå’Œ SQL æŸ¥è©¢
- ğŸ“Š è³‡æ–™åº«çµæ§‹æ¦‚è¦½
- ğŸ”’ å®‰å…¨æ€§èªªæ˜å’Œ RLS æ”¿ç­–è§£é‡‹
- ğŸ› å¸¸è¦‹å•é¡Œæ’è§£
- âœ… éƒ¨ç½²å¾Œæª¢æŸ¥æ¸…å–®
- ğŸ”„ å›æ»¾æŒ‡ä»¤
- ğŸ“š ç›¸é—œæ–‡ä»¶é€£çµ

### 3. å¿«é€Ÿéƒ¨ç½²åƒè€ƒ

å»ºç«‹äº† `firebase/QUICK_DEPLOY.md` - ä¸€éµè¤‡è£½è²¼ä¸ŠæŒ‡å—

**ç‰¹è‰²**ï¼š
- ğŸš€ ä¸‰ç¨®æ–¹æ³•çš„å¿«é€Ÿå‘½ä»¤
- ğŸ“‹ å¯ç›´æ¥è¤‡è£½è²¼ä¸Šçš„å®Œæ•´æŒ‡ä»¤
- âœ… é©—è­‰ SQL æŸ¥è©¢
- ğŸ†˜ å¿«é€Ÿæ’éŒ¯æŒ‡ä»¤
- ğŸ“± é‡è¦é€£çµæ•´ç†

## ğŸ“¦ Migration æª”æ¡ˆæ¦‚è¦½

å°ˆæ¡ˆåŒ…å« 6 å€‹ SQL migration æª”æ¡ˆï¼Œå¿…é ˆ**ä¾åºåŸ·è¡Œ**ï¼š

| é †åº | æª”æ¡ˆåç¨± | èªªæ˜ | è¡Œæ•¸ |
|------|----------|------|------|
| 1 | `20251212_01_create_tasks_table.sql` | å»ºç«‹ä»»å‹™è¡¨æ ¼ | 130 |
| 2 | `20251212_02_create_logs_table.sql` | å»ºç«‹æ—¥èªŒè¡¨æ ¼ | 173 |
| 3 | `20251212_03_create_rls_policies.sql` | å»ºç«‹ RLS å®‰å…¨æ”¿ç­– | 371 |
| 4 | `20251212_04_create_notifications_table.sql` | å»ºç«‹é€šçŸ¥è¡¨æ ¼ | 174 |
| 5 | `20251212_04_task_quantity_expansion.sql` | ä»»å‹™æ•¸é‡è¿½è¹¤æ“´å±• | 294 |
| 6 | `20251212_05_task_quantity_rls_policies.sql` | æ•¸é‡æ“´å±• RLS æ”¿ç­– | 348 |

**ç¸½è¨ˆ**ï¼š1,490 è¡Œ SQL ç¨‹å¼ç¢¼

## ğŸ—„ï¸ å°‡å»ºç«‹çš„è³‡æ–™åº«çµæ§‹

### ä¸»è¦è¡¨æ ¼ï¼ˆ6 å€‹ï¼‰

1. **tasks** - ä»»å‹™ç®¡ç†
   - 9 å€‹ç´¢å¼•
   - 5 å€‹ RLS æ”¿ç­–
   - è‡ªå‹•æ›´æ–°æ™‚é–“æˆ³è¨˜è§¸ç™¼å™¨

2. **logs** - æ–½å·¥æ—¥èªŒ
   - 9 å€‹ç´¢å¼•ï¼ˆåŒ…å« GIN ç´¢å¼•ï¼‰
   - 6 å€‹ RLS æ”¿ç­–
   - ç…§ç‰‡çµ±è¨ˆè‡ªå‹•æ›´æ–°

3. **notifications** - é€šçŸ¥ç³»çµ±
   - 4 å€‹ç´¢å¼•
   - 4 å€‹ RLS æ”¿ç­–
   - æ”¯æ´ä¸‰ç¨®é¡å‹ï¼šé€šçŸ¥ã€æ¶ˆæ¯ã€å¾…è¾¦

4. **log_tasks** - ä»»å‹™èˆ‡æ—¥èªŒé—œè¯
   - 4 å€‹ç´¢å¼•
   - 4 å€‹ RLS æ”¿ç­–

5. **quality_controls** - å“è³ªç®¡æ§
   - 5 å€‹ç´¢å¼•
   - 5 å€‹ RLS æ”¿ç­–

6. **task_progress** - ä»»å‹™é€²åº¦å¯©è¨ˆè¨˜éŒ„
   - 6 å€‹ç´¢å¼•
   - 2 å€‹ RLS æ”¿ç­–

### Helper å‡½å¼ï¼ˆ11 å€‹ï¼‰

- `update_updated_at_column()` - è‡ªå‹•æ›´æ–°æ™‚é–“æˆ³è¨˜
- `update_log_photo_stats()` - æ›´æ–°ç…§ç‰‡çµ±è¨ˆ
- `get_user_organization_id()` - å–å¾—ä½¿ç”¨è€…çµ„ç¹” ID
- `get_user_id()` - å–å¾—ä½¿ç”¨è€… ID
- `get_user_role()` - å–å¾—ä½¿ç”¨è€…è§’è‰²
- `is_blueprint_in_user_organization()` - æª¢æŸ¥è—åœ–æ‰€å±¬çµ„ç¹”
- `calculate_task_completed_quantity()` - è¨ˆç®—ä»»å‹™å®Œæˆæ•¸é‡
- `update_task_completed_quantity()` - æ›´æ–°ä»»å‹™å®Œæˆæ•¸é‡
- `user_can_access_blueprint()` - æª¢æŸ¥è—åœ–å­˜å–æ¬Šé™
- `user_is_qc_inspector()` - æª¢æŸ¥æ˜¯å¦ç‚ºå“ç®¡äººå“¡
- `user_is_admin()` - æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
- `test_rls_policies()` - æ¸¬è©¦ RLS æ”¿ç­–

### å®‰å…¨ç‰¹æ€§

- âœ… **æ‰€æœ‰è¡¨æ ¼å•Ÿç”¨ RLS**ï¼ˆRow Level Securityï¼‰
- âœ… **çµ„ç¹”éš”é›¢**ï¼šä½¿ç”¨è€…åªèƒ½å­˜å–è‡ªå·±çµ„ç¹”çš„è³‡æ–™
- âœ… **è§’è‰²æ¬Šé™**ï¼šadmin, member, viewer ä¸‰ç¨®è§’è‰²
- âœ… **å‰µå»ºè€…æ¬Šé™**ï¼šä½¿ç”¨è€…å¯ç·¨è¼¯è‡ªå·±çš„è³‡æ–™
- âœ… **è»Ÿåˆªé™¤æ”¯æ´**ï¼šdeleted_at æ¬„ä½
- âœ… **é è¨­æ‹’çµ•**ï¼šanonymous ä½¿ç”¨è€…ç„¡å­˜å–æ¬Šé™

## ğŸš€ ç«‹å³é–‹å§‹éƒ¨ç½²

### æœ€ç°¡å–®çš„æ–¹æ³•ï¼š

1. **å–å¾—è³‡æ–™åº«å¯†ç¢¼**
   - å‰å¾€ï¼šhttps://firebase.com/dashboard/project/zecsbstjqjqoytwgjyct/settings/database
   - è¤‡è£½ Direct Connection é€£ç·šå­—ä¸²

2. **åŸ·è¡Œéƒ¨ç½²è…³æœ¬**
   ```bash
   cd /path/to/GigHub
   export DATABASE_URL='postgresql://postgres:YOUR_PASSWORD@db.zecsbstjqjqoytwgjyct.firebase.co:5432/postgres'
   ```

3. **é©—è­‰éƒ¨ç½²**
   - è…³æœ¬æœƒè‡ªå‹•åŸ·è¡Œé©—è­‰
   - æˆ–æ‰‹å‹•åœ¨ Firebase Dashboard æª¢æŸ¥

## ğŸ“š è©³ç´°æ–‡æª”

- **å®Œæ•´æŒ‡å—**ï¼š[firebase/éƒ¨ç½²æŒ‡å—.md](./firebase/éƒ¨ç½²æŒ‡å—.md)
- **å¿«é€Ÿåƒè€ƒ**ï¼š[firebase/QUICK_DEPLOY.md](./firebase/QUICK_DEPLOY.md)

## âš ï¸ é‡è¦æ³¨æ„äº‹é …

1. **åŸ·è¡Œé †åº**ï¼šå¿…é ˆæŒ‰ç…§æª”æ¡ˆç·¨è™Ÿé †åºåŸ·è¡Œ
2. **RLS ä¾è³´**ï¼šæŸäº› RLS æ”¿ç­–ä¾è³´ `blueprints` è¡¨æ ¼
3. **JWT Claims**ï¼šæ‡‰ç”¨ç¨‹å¼éœ€è¦é…ç½® `organization_id` å’Œ `role` claims
4. **å‚™ä»½**ï¼šå»ºè­°å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰
5. **å›æ»¾**ï¼šæ–‡æª”ä¸­åŒ…å«å®Œæ•´çš„å›æ»¾ SQL

## ğŸ¯ ä¸‹ä¸€æ­¥

éƒ¨ç½²å®Œæˆå¾Œï¼š

1. âœ… åœ¨ Firebase Dashboard é©—è­‰è¡¨æ ¼å’Œæ”¿ç­–
2. âœ… é…ç½® Firebase Auth Custom Claims
3. âœ… æ›´æ–°å‰ç«¯æ‡‰ç”¨ç¨‹å¼é€£æ¥åˆ°æ–°è³‡æ–™åº«
4. âœ… æ¸¬è©¦ CRUD æ“ä½œå’Œæ¬Šé™
5. âœ… ç›£æ§æ•ˆèƒ½å’ŒéŒ¯èª¤æ—¥èªŒ

## ğŸ“ æ”¯æ´è³‡æº

- **Firebase Dashboard**: https://firebase.com/dashboard/project/zecsbstjqjqoytwgjyct
- **SQL Editor**: https://firebase.com/dashboard/project/zecsbstjqjqoytwgjyct/editor
- **Database Logs**: https://firebase.com/dashboard/project/zecsbstjqjqoytwgjyct/logs/explorer

## âœ¨ æŠ€è¡“äº®é»

- ğŸ”¥ **å…¨è‡ªå‹•åŒ–**ï¼šä¸€éµéƒ¨ç½²æ‰€æœ‰ migrations
- ğŸ›¡ï¸ **ä¼æ¥­ç´šå®‰å…¨**ï¼šå®Œæ•´çš„ RLS æ”¿ç­–å’Œçµ„ç¹”éš”é›¢
- ğŸ“Š **æ•ˆèƒ½å„ªåŒ–**ï¼š30+ å€‹ç´¢å¼•å’ŒæŸ¥è©¢å„ªåŒ–
- ğŸ” **å¯è¿½æº¯æ€§**ï¼šå®Œæ•´çš„å¯©è¨ˆè¨˜éŒ„ï¼ˆtask_progressï¼‰
- ğŸ§ª **å¯æ¸¬è©¦æ€§**ï¼šå…§å»ºæ¸¬è©¦å‡½å¼
- ğŸ“ **å®Œæ•´æ–‡æª”**ï¼šä¸­æ–‡æŒ‡å—å’Œç¯„ä¾‹

---

**å»ºç«‹æ—¥æœŸ**ï¼š2025-12-12  
**å°ˆæ¡ˆ ID**ï¼šzecsbstjqjqoytwgjyct  
**ç‹€æ…‹**ï¼šâœ… æº–å‚™å°±ç·’ï¼Œå¯ä»¥éƒ¨ç½²  
**é è¨ˆæ™‚é–“**ï¼š5-10 åˆ†é˜
