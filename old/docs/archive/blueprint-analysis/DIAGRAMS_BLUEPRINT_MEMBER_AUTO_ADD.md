# 藍圖建立流程圖（含自動加入成員功能）

## 整體流程圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         使用者建立藍圖流程                                      │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌──────────────────┐
                    │   使用者點擊     │
                    │  「建立藍圖」    │
                    └────────┬─────────┘
                             │
                             ▼
                    ┌──────────────────┐
                    │ BlueprintModal   │
                    │  開啟表單        │
                    └────────┬─────────┘
                             │
                             │ 填寫資料
                             │ (name, slug, etc.)
                             │
                             ▼
                    ┌──────────────────┐
                    │  表單驗證        │
                    │  (前端驗證)      │
                    └────────┬─────────┘
                             │
                             │ ✅ 驗證通過
                             │
                             ▼
                    ┌──────────────────┐
                    │ 建立 Request     │
                    │ + createdBy uid  │ ← ✨ 新增欄位
                    └────────┬─────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                       BlueprintService.create()                            │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  1️⃣ 驗證請求 (ValidationService)                                           │
│     ├─ 驗證 name, slug, ownerId, ownerType                                │
│     └─ ✨ 驗證 createdBy (必填)                                            │
│                                                                            │
│  2️⃣ 建立藍圖 (BlueprintRepository.create)                                  │
│     ├─ 寫入 Firestore: blueprints/{id}                                    │
│     └─ 返回建立的 Blueprint 物件                                           │
│                                                                            │
│  3️⃣ 記錄 Audit Log (BLUEPRINT_CREATED)                                    │
│     └─ 寫入: blueprints/{id}/audit_logs                                   │
│                                                                            │
│  4️⃣ ✨ 自動加入建立者為成員 (NEW!)                                          │
│     ├─ 呼叫 BlueprintMemberRepository.addMember()                         │
│     ├─ accountId: request.createdBy                                       │
│     ├─ role: MAINTAINER                                                   │
│     ├─ permissions: {                                                     │
│     │    canManageMembers: true,                                          │
│     │    canManageSettings: true,                                         │
│     │    canExportData: true,                                             │
│     │    canDeleteBlueprint: true                                         │
│     │  }                                                                  │
│     └─ grantedBy: request.createdBy                                       │
│                                                                            │
│  5️⃣ 記錄 Audit Log (MEMBER_ADDED)                                         │
│     └─ 寫入: blueprints/{id}/audit_logs                                   │
│                                                                            │
│  6️⃣ 錯誤處理 (Graceful Degradation)                                        │
│     ├─ 成員新增失敗 → 記錄錯誤                                             │
│     └─ 藍圖建立成功 → 返回 Blueprint                                       │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
                             │
                             │ ✅ 返回 Blueprint
                             │
                             ▼
                    ┌──────────────────┐
                    │  顯示成功訊息    │
                    │  導航至藍圖頁面  │
                    └──────────────────┘
```

## 資料流圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              資料流向                                         │
└─────────────────────────────────────────────────────────────────────────────┘

使用者輸入                     CreateBlueprintRequest                    Firestore
───────────                    ──────────────────────                    ─────────

name: "測試藍圖"     ──┐
slug: "test"         ──┤
description: "..."   ──┤
ownerId: "org123"    ──┤──▶  {                            ──▶  blueprints/
ownerType: "org"     ──┤       name,                              {
isPublic: false      ──┤       slug,                               id,
enabledModules: []   ──┤       description,                        name,
                       │       ownerId,                            ...
currentUser.uid      ──┘──▶    ownerType,                          createdBy ✨
                               isPublic,                         }
                               enabledModules,
                               createdBy ✨              ──▶  blueprints/{id}/members/
                             }                                    {
                                                                   id,
                                                                   accountId: createdBy ✨
                                                                   role: "MAINTAINER" ✨
                                                                   permissions: {...} ✨
                                                                   grantedBy: createdBy ✨
                                                                 }

                                                         ──▶  blueprints/{id}/audit_logs/
                                                                { BLUEPRINT_CREATED }
                                                                { MEMBER_ADDED } ✨
```

## 錯誤處理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          錯誤處理 & Graceful Degradation                      │
└─────────────────────────────────────────────────────────────────────────────┘

BlueprintService.create() 執行流程
══════════════════════════════════════════════════════════════════════════════

try {
  ┌──────────────────────────┐
  │ 1. 驗證請求              │
  │    ├─ ✅ 驗證通過        │
  │    └─ ❌ 驗證失敗 → throw│
  └──────────┬───────────────┘
             │
             ▼
  ┌──────────────────────────┐
  │ 2. 建立藍圖              │
  │    ├─ ✅ 建立成功        │
  │    └─ ❌ 建立失敗 → throw│
  └──────────┬───────────────┘
             │
             ▼
  ┌──────────────────────────┐
  │ 3. 記錄 Audit Log        │
  │    └─ ❌ 失敗 → 僅記錄   │ ← Graceful
  └──────────┬───────────────┘
             │
             ▼
  ┌──────────────────────────┐
  │ 4. ✨ 加入成員 (NEW!)    │
  │                          │
  │ try {                    │
  │   addMember()            │
  │   ├─ ✅ 成功             │
  │   │   └─ 記錄 Audit Log  │
  │   │                      │
  │   └─ ❌ 失敗             │ ← Graceful
  │       ├─ 記錄錯誤        │   Degradation
  │       ├─ 記錄警告        │
  │       └─ 繼續執行 ✅     │
  │ }                        │
  └──────────┬───────────────┘
             │
             ▼
  ┌──────────────────────────┐
  │ 5. 返回 Blueprint        │
  │    └─ ✅ 成功返回        │
  └──────────────────────────┘

} catch (error) {
  ┌──────────────────────────┐
  │ 記錄錯誤                 │
  │ throw error              │
  │ └─ UI 顯示錯誤訊息       │
  └──────────────────────────┘
}

══════════════════════════════════════════════════════════════════════════════
關鍵設計決策：
• 藍圖建立是主要操作 → 失敗必須拋出錯誤
• 成員加入是次要功能 → 失敗不影響藍圖建立
• Audit log 是輔助功能 → 失敗僅記錄，不影響主流程
══════════════════════════════════════════════════════════════════════════════
```

## 權限模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         藍圖成員權限模型                                       │
└─────────────────────────────────────────────────────────────────────────────┘

建立者自動成為 MAINTAINER
═════════════════════════════════════════════════════════════════════════════

BlueprintMember {
  id: "member-uuid",
  blueprintId: "blueprint-id",
  accountId: "creator-uid",              ← 建立者的 Firebase Auth UID
  role: "MAINTAINER",                    ← ✨ 最高權限角色
  businessRole: undefined,               ← 可選的業務角色
  isExternal: false,                     ← 非外部成員
  grantedBy: "creator-uid",              ← 由建立者授予
  grantedAt: Timestamp,                  ← 授予時間
  permissions: {                         ← ✨ 完整權限
    canManageMembers: true,              ← 可新增/移除/編輯成員
    canManageSettings: true,             ← 可修改藍圖設定
    canExportData: true,                 ← 可匯出資料
    canDeleteBlueprint: true             ← 可刪除藍圖
  }
}

角色階層
────────────────────────────────────────────────────────────────────────────

┌──────────────────┐
│   MAINTAINER     │  ← 建立者預設角色 ✨
│  (完整管理權限)   │     • 可管理成員
└────────┬─────────┘     • 可管理設定
         │               • 可匯出資料
         │               • 可刪除藍圖
         ▼
┌──────────────────┐
│   CONTRIBUTOR    │     • 可編輯內容
│  (編輯權限)      │     • 可新增資料
└────────┬─────────┘     • 不可管理設定
         │
         ▼
┌──────────────────┐
│     VIEWER       │     • 唯讀訪問
│  (檢視權限)      │     • 不可編輯
└──────────────────┘
```

## 時序圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          建立藍圖時序圖                                        │
└─────────────────────────────────────────────────────────────────────────────┘

使用者         Modal         Service       Repository    MemberRepo    Firestore
  │             │              │               │              │            │
  │ 點擊建立    │              │               │              │            │
  │────────────▶│              │               │              │            │
  │             │              │               │              │            │
  │ 填寫表單    │              │               │              │            │
  │────────────▶│              │               │              │            │
  │             │              │               │              │            │
  │ 提交        │              │               │              │            │
  │────────────▶│ create(req) │               │              │            │
  │             │─────────────▶│ validate      │              │            │
  │             │              │───────┐       │              │            │
  │             │              │       │ ✅    │              │            │
  │             │              │◀──────┘       │              │            │
  │             │              │ create(data)  │              │            │
  │             │              │──────────────▶│ write        │            │
  │             │              │               │─────────────▶│            │
  │             │              │               │              │ ✅ 寫入    │
  │             │              │               │◀─────────────│            │
  │             │              │◀──────────────│ Blueprint    │            │
  │             │              │               │              │            │
  │             │              │ ✨ addMember()│              │            │
  │             │              │───────────────┼─────────────▶│ write     │
  │             │              │               │              │──────────▶│
  │             │              │               │              │           │
  │             │              │               │              │◀──────────│
  │             │              │               │              │  ✅ 成員   │
  │             │              │◀──────────────┼──────────────│           │
  │             │              │               │              │           │
  │             │◀─────────────│ Blueprint     │              │           │
  │◀────────────│ success      │               │              │           │
  │ 顯示成功    │              │               │              │           │
  │             │              │               │              │           │
```

## 狀態轉換圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        藍圖建立狀態轉換                                        │
└─────────────────────────────────────────────────────────────────────────────┘

     ┌──────────┐
     │   開始   │
     └────┬─────┘
          │
          ▼
     ┌─────────────┐
     │  表單輸入    │
     └────┬────────┘
          │ 提交
          ▼
     ┌─────────────┐
     │  驗證中      │
     └──┬──────┬───┘
        │      │
   ✅   │      │  ❌
        │      └──────────┐
        ▼                 │
     ┌─────────────┐      │
     │  建立藍圖    │      │
     └────┬────────┘      │
          │               │
     ✅   │               │
          ▼               │
     ┌─────────────┐      │
     │✨加入成員    │      │
     └──┬──────┬───┘      │
        │      │          │
   ✅   │      │ ❌       │
        │      │ (Graceful)│
        │      │          │
        └──┬───┘          │
           │              │
           ▼              ▼
     ┌─────────────┐  ┌─────────────┐
     │  建立成功    │  │  建立失敗    │
     │  • 藍圖 ✅   │  │  • 顯示錯誤  │
     │  • 成員 ✅   │  │  • 保持表單  │
     │  (或 ⚠️)    │  └─────────────┘
     └─────────────┘
           │
           ▼
     ┌─────────────┐
     │  導航至藍圖  │
     └─────────────┘
```

## 架構圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          系統架構圖                                           │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           Presentation Layer                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐     │
│  │ BlueprintModalComponent                                           │     │
│  │  • 表單處理                                                        │     │
│  │  • 使用者輸入驗證                                                  │     │
│  │  • ✨ 傳遞 createdBy (NEW!)                                       │     │
│  └───────────────────────────────────────────────────────────────────┘     │
│                                    │                                        │
└────────────────────────────────────┼────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Business Layer                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐     │
│  │ BlueprintService                                                  │     │
│  │  • 業務邏輯協調                                                    │     │
│  │  • 驗證處理                                                        │     │
│  │  • ✨ 自動加入成員邏輯 (NEW!)                                     │     │
│  │  • Audit log 記錄                                                 │     │
│  │  • 錯誤處理 (Graceful Degradation)                               │     │
│  └────────────┬──────────────────────────────┬───────────────────────┘     │
│               │                              │                             │
└───────────────┼──────────────────────────────┼─────────────────────────────┘
                │                              │
                ▼                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Infrastructure Layer                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────┐   ┌────────────────────────────────────┐   │
│  │ BlueprintRepository        │   │ BlueprintMemberRepository         │   │
│  │  • Firestore 操作          │   │  • ✨ 成員管理 (USED!)             │   │
│  │  • 資料持久化              │   │  • 權限設定                       │   │
│  │  • CRUD 操作               │   │  • 角色管理                       │   │
│  └────────────┬───────────────┘   └────────────┬───────────────────────┘   │
│               │                                │                           │
└───────────────┼────────────────────────────────┼───────────────────────────┘
                │                                │
                ▼                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                               Firestore                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────┐   ┌────────────────────────────────────┐  │
│  │ blueprints/{id}             │   │ blueprints/{id}/members/{mid}     │  │
│  │  • name                     │   │  • ✨ accountId: createdBy         │  │
│  │  • slug                     │   │  • ✨ role: MAINTAINER             │  │
│  │  • ownerId                  │   │  • ✨ permissions: {...}           │  │
│  │  • ✨ createdBy              │   │  • grantedBy                      │  │
│  │  • ...                      │   │  • grantedAt                      │  │
│  └─────────────────────────────┘   └────────────────────────────────────┘  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ blueprints/{id}/audit_logs/{logId}                                 │   │
│  │  • ✨ BLUEPRINT_CREATED                                             │   │
│  │  • ✨ MEMBER_ADDED (NEW!)                                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 圖例說明

- ✨ **NEW!** - 本次實作新增的功能或欄位
- ✅ - 成功路徑
- ❌ - 失敗路徑
- ⚠️ - 部分成功（Graceful Degradation）
- 🔴 - 必須處理的錯誤
- 🟡 - 可選處理的警告

---

本文件提供視覺化的實作說明，幫助理解自動加入成員功能的運作方式。
